var h=(o,e,t)=>new Promise((s,r)=>{var n=i=>{try{a(t.next(i))}catch(p){r(p)}},c=i=>{try{a(t.throw(i))}catch(p){r(p)}},a=i=>i.done?s(i.value):Promise.resolve(i.value).then(n,c);a((t=t.apply(o,e)).next())});import u from"on-change";import{useEffect as v,useRef as l,useState as b}from"react";var f=new EventTarget,w=0,g=class{constructor(e,t={}){this.onChangeListeners=[];this.options=t,this.id=w++,this.eventType=`STORE_${this.id}_WATCHI_UPDATE`,this.event=new Event(this.eventType),this.store=this.set(e),this.useWatch=this.useWatch.bind(this),this.useRefWatch=this.useRefWatch.bind(this)}set(e,t=!0){return this.store&&u.unsubscribe(this.store),this.store=u(e,(...s)=>{for(let r of this.onChangeListeners)r(...s);this.trigger()},{pathAsArray:!0,ignoreSymbols:!0}),t&&this.trigger(),this.store}trigger(){f.dispatchEvent(this.event)}watch(e){return f.addEventListener(this.eventType,e),()=>f.removeEventListener(this.eventType,e)}withGlobalChanges(e,t){return h(this,null,function*(){let s=(n,c,a)=>e.push([n,a]);this.onChangeListeners.push(s);let r;try{r=yield t()}finally{let n=this.onChangeListeners.indexOf(s);n!==-1&&this.onChangeListeners.splice(n,1)}return r})}revertStoreChanges(e){R(u.target(this.store),e),this.trigger()}revertable(e){return y(this.store,e)}revertableGlobal(e){return h(this,null,function*(){let t=[];return yield this.withGlobalChanges(t,()=>e(()=>this.revertStoreChanges(t)))})}transaction(e){return h(this,null,function*(){let t=u.target(this.store);y(t,(s,r)=>h(this,null,function*(){try{yield e(s),this.trigger()}catch(n){throw r(),n}}))})}revertOnError(e,t){this.revertable((s,r)=>h(this,null,function*(){try{yield e(s)}catch(n){if((t?t(n):!0)===!0&&r(),!t)if(this.options.defaultOnError)this.options.defaultOnError(n);else throw n}}))}revertOnErrorGlobal(e,t){return h(this,null,function*(){yield this.revertableGlobal(s=>h(this,null,function*(){try{yield e()}catch(r){if((t?t(r):!0)===!0&&s(),!t)if(this.options.defaultOnError)this.options.defaultOnError(r);else throw r}}))})}useWatch(e,t=(s,r)=>!Object.is(s,r)){let[s,r]=b(e(this.store)),n=l(s),c=l(e),a=l(t);return c.current=e,a.current=t,v(()=>this.watch(()=>{let i=c.current(this.store);(typeof a.current=="boolean"?a.current:a.current(i,n.current))&&(i===n.current&&typeof i=="object"&&(Array.isArray(i)?i=i.slice(0):i=Object.assign({},i)),r(i),n.current=i)}),[]),s}useRefWatch(e){let t=l(e(this.store)),s=l(e);return s.current=e,v(()=>this.watch(()=>{let r=s.current(this.store);Object.is(r,t.current)||(t.current=r)}),[]),t}target(e){return u.target(e)}};function d(o,e,t){let s=e.at(-1);if(s!==null){if(s===void 0){if(Array.isArray(o)&&Array.isArray(t)){o.splice(0,o.length);for(let r of t)o.push(r)}return}for(let r=0;r<e.length-1;r++)o=o[e[r]];o[s]=t}}function R(o,e){for(;e.length;){let t=e.pop();t&&d(o,t[0],t[1])}}function y(o,e){let t=[],s=u(o,(n,c,a)=>{t.push([n,a])},{pathAsArray:!0,ignoreSymbols:!0}),r;try{r=e(s,()=>R(o,t))}finally{u.unsubscribe(s)}return r}export{g as default};
