var u=(i,e,t)=>new Promise((n,r)=>{var o=s=>{try{h(t.next(s))}catch(p){r(p)}},a=s=>{try{h(t.throw(s))}catch(p){r(p)}},h=s=>s.done?n(s.value):Promise.resolve(s.value).then(o,a);h((t=t.apply(i,e)).next())});import c from"on-change";import{useEffect as v,useRef as l,useState as b}from"react";var f=new EventTarget,d=0,g=class{constructor(e,t={}){this.onChangeListeners=[];this.options=t,this.id=d++,this.eventType=`STORE_${this.id}_WATCHI_UPDATE`,this.event=new Event(this.eventType),this.store=this.set(e),this.useWatch=this.useWatch.bind(this),this.useRefWatch=this.useRefWatch.bind(this)}set(e,t=!0){return this.store&&c.unsubscribe(this.store),this.store=c(e,(...n)=>{for(let r of this.onChangeListeners)r(...n);this.trigger()},{pathAsArray:!0,ignoreSymbols:!0}),t&&this.trigger(),this.store}trigger(){f.dispatchEvent(this.event)}watch(e){return f.addEventListener(this.eventType,e),()=>f.removeEventListener(this.eventType,e)}withGlobalChanges(e,t){return u(this,null,function*(){let n=(r,o,a)=>e.push([r,a]);this.onChangeListeners.push(n);try{yield t()}finally{let r=this.onChangeListeners.indexOf(n);r!==-1&&this.onChangeListeners.splice(r,1)}})}revertStoreChanges(e){w(c.target(this.store),e),this.trigger()}revertable(e){return y(this.store,e)}revertableGlobal(e){return u(this,null,function*(){let t=[];yield this.withGlobalChanges(t,()=>e(()=>this.revertStoreChanges(t)))})}transaction(e){return u(this,null,function*(){let t=c.target(this.store);y(t,(n,r)=>u(this,null,function*(){try{yield e(n),this.trigger()}catch(o){throw r(),o}}))})}revertOnError(e,t){this.revertable((n,r)=>u(this,null,function*(){try{yield e(n)}catch(o){if((t?t(o):!0)===!0&&r(),!t)if(this.options.defaultOnError)this.options.defaultOnError(o);else throw o}}))}revertOnErrorGlobal(e,t){return u(this,null,function*(){yield this.revertableGlobal(n=>u(this,null,function*(){try{yield e()}catch(r){if((t?t(r):!0)===!0&&n(),!t)if(this.options.defaultOnError)this.options.defaultOnError(r);else throw r}}))})}useWatch(e,t=(n,r)=>!Object.is(n,r)){let[n,r]=b(e(this.store)),o=l(n),a=l(e),h=l(t);return a.current=e,h.current=t,v(()=>this.watch(()=>{let s=a.current(this.store);(typeof h.current=="boolean"?h.current:h.current(s,o.current))&&(s===o.current&&typeof s=="object"&&(Array.isArray(s)?s=s.slice(0):s=Object.assign({},s)),r(s),o.current=s)}),[]),n}useRefWatch(e){let t=l(e(this.store)),n=l(e);return n.current=e,v(()=>this.watch(()=>{let r=n.current(this.store);Object.is(r,t.current)||(t.current=r)}),[]),t}target(e){return c.target(e)}};function S(i,e,t){let n=e.at(-1);if(n!==null){if(n===void 0){if(Array.isArray(i)&&Array.isArray(t)){i.splice(0,i.length);for(let r of t)i.push(r)}return}for(let r=0;r<e.length-1;r++)i=i[e[r]];i[n]=t}}function w(i,e){for(;e.length;){let t=e.pop();t&&S(i,t[0],t[1])}}function y(i,e){let t=[],n=c(i,(r,o,a)=>{t.push([r,a])},{pathAsArray:!0,ignoreSymbols:!0});try{e(n,()=>w(i,t))}finally{c.unsubscribe(n)}}export{g as default};
