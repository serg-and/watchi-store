"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }var u=(i,t,e)=>new Promise((n,r)=>{var s=c=>{try{h(e.next(c))}catch(o){r(o)}},a=c=>{try{h(e.throw(c))}catch(o){r(o)}},h=c=>c.done?n(c.value):Promise.resolve(c.value).then(s,a);h((e=e.apply(i,t)).next())});var _onchange = require('on-change'); var _onchange2 = _interopRequireDefault(_onchange);var _react = require('react');var f=new EventTarget,y=0,g= exports.default =class{constructor(t,e={}){this.onChangeListeners=[];this.options=e,this.id=y,y++,this.eventType=`STORE_${this.id}_WATCHI_UPDATE`,this.event=new Event(this.eventType),this.store=this.set(t),this.useWatch=this.useWatch.bind(this),this.useRefWatch=this.useRefWatch.bind(this)}set(t,e=!0){return this.store&&_onchange2.default.unsubscribe(this.store),this.store=_onchange2.default.call(void 0, t,(...n)=>{for(let r of this.onChangeListeners)r(...n);this.trigger()},{pathAsArray:!0,ignoreSymbols:!0}),e&&this.trigger(),this.store}trigger(){f.dispatchEvent(this.event)}watch(t){return f.addEventListener(this.eventType,t),()=>f.removeEventListener(this.eventType,t)}withGlobalChanges(t,e){return u(this,null,function*(){let n=(r,s,a)=>t.push([r,a]);this.onChangeListeners.push(n);try{yield e()}finally{let r=this.onChangeListeners.indexOf(n);r!==-1&&this.onChangeListeners.splice(r,1)}})}revertStoreChanges(t){b(_onchange2.default.target(this.store),t),this.trigger()}revertable(t){return w(this.store,t)}revertableGlobal(t){return u(this,null,function*(){let e=[];yield this.withGlobalChanges(e,()=>t(()=>this.revertStoreChanges(e)))})}transaction(t){return u(this,null,function*(){let e=_onchange2.default.target(this.store);w(e,(n,r)=>u(this,null,function*(){try{yield t(n),this.trigger()}catch(s){throw r(),s}}))})}revertOnError(t,e){this.revertable((n,r)=>u(this,null,function*(){try{yield t(n)}catch(s){if((e?e(s):!0)===!0&&r(),!e)if(this.options.defaultOnError)this.options.defaultOnError(s);else throw s}}))}revertOnErrorGlobal(t,e){return u(this,null,function*(){yield this.revertableGlobal(n=>u(this,null,function*(){try{yield t()}catch(r){if((e?e(r):!0)===!0&&n(),!e)if(this.options.defaultOnError)this.options.defaultOnError(r);else throw r}}))})}useWatch(t,e=(n,r)=>!Object.is(n,r)){let[n,r]=_react.useState.call(void 0, t(this.store)),s=_react.useRef.call(void 0, n),a=_react.useRef.call(void 0, t),h=_react.useRef.call(void 0, e);return a.current=t,h.current=e,_react.useEffect.call(void 0, ()=>this.watch(()=>{let o=a.current(this.store);(typeof h.current=="boolean"?h.current:h.current(o,s.current))&&(o===s.current&&typeof o=="object"&&(Array.isArray(o)?o=o.slice(0):o=Object.assign({},o)),r(o),s.current=o)}),[]),n}useRefWatch(t){let e=_react.useRef.call(void 0, t(this.store)),n=_react.useRef.call(void 0, t);return n.current=t,_react.useEffect.call(void 0, ()=>this.watch(()=>{let s=n.current(this.store);Object.is(s,e.current)||(e.current=s)}),[]),e}};function S(i,t,e){let n=t.at(-1);if(n!==null){if(n===void 0){if(Array.isArray(i)&&Array.isArray(e)){i.splice(0,i.length);for(let r of e)i.push(r)}return}for(let r=0;r<t.length-1;r++)i=i[t[r]];i[n]=e}}function b(i,t){for(;t.length;){let e=t.pop();e&&S(i,e[0],e[1])}}function w(i,t){let e=[],n=_onchange2.default.call(void 0, i,(r,s,a)=>{e.push([r,a])},{pathAsArray:!0,ignoreSymbols:!0});try{t(n,()=>b(i,e))}finally{_onchange2.default.unsubscribe(n)}}exports.default = g;
