"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }var _onchange = require('on-change'); var _onchange2 = _interopRequireDefault(_onchange);var _react = require('react');var a=new EventTarget,f=[],u= exports.default =class{constructor(t,e){if(f.includes(e.toUpperCase()))throw`Store "${e}" already exists`;this.eventType=`${e.toUpperCase()}_WATCHI_UPDATE`,this.event=new Event(this.eventType),this.store=_onchange2.default.call(void 0, t,()=>this.trigger()),f.push(e.toUpperCase())}trigger(){a.dispatchEvent(this.event)}watch(t){return a.addEventListener(this.eventType,t),()=>a.removeEventListener(this.eventType,t)}revertable(t){return S(this.store,t)}transaction(t){let e=_onchange2.default.target(this.store);S(e,(s,r)=>{try{t(s),this.trigger()}catch(n){throw r(),n}})}revertOnError(t,e){let s=structuredClone(this.store);try{t()}catch(r){if((e?e(r):!0)===!0&&Object.assign(this.store,s),!e)throw r}}useWatch(t,e=(s,r)=>!Object.is(s,r)){let[s,r]=_react.useState.call(void 0, t(this.store)),n=_react.useRef.call(void 0, s);return _react.useEffect.call(void 0, ()=>this.watch(()=>{let c=t(this.store);(typeof e=="boolean"?e:e(c,n.current))&&(r(c),n.current=c)}),[]),s}useRefWatch(t){let e=_react.useRef.call(void 0, t(this.store));return _react.useEffect.call(void 0, ()=>this.watch(()=>{let r=t(this.store);Object.is(r,e.current)||(e.current=r)}),[]),e}};function w(o,t,e){let s=t.at(-1);if(s!=null){for(let r=0;r<t.length-1;r++)o=o[t[r]];o[s]=e}}function S(o,t){let e=[],s=_onchange2.default.call(void 0, o,(n,i,c)=>{e.push([n,c])},{pathAsArray:!0});function r(){for(let[n,i]of e.reverse())w(o,n,i)}t(s,r)}exports.default = u;
