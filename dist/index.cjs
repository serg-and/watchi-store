"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }var a=(s,t,e)=>new Promise((n,r)=>{var o=h=>{try{i(e.next(h))}catch(l){r(l)}},c=h=>{try{i(e.throw(h))}catch(l){r(l)}},i=h=>h.done?n(h.value):Promise.resolve(h.value).then(o,c);i((e=e.apply(s,t)).next())});var _onchange = require('on-change'); var _onchange2 = _interopRequireDefault(_onchange);var _react = require('react');var f=new EventTarget,y=0,g= exports.default =class{constructor(t,e={}){this.onChangeListeners=[];this.options=e,this.id=y,y++,this.eventType=`STORE_${this.id}_WATCHI_UPDATE`,this.event=new Event(this.eventType),this.store=this.set(t),this.useWatch=this.useWatch.bind(this),this.useRefWatch=this.useRefWatch.bind(this)}set(t,e=!0){return this.store&&_onchange2.default.unsubscribe(this.store),this.store=_onchange2.default.call(void 0, t,(...n)=>{for(let r of this.onChangeListeners)r(...n);this.trigger()},{pathAsArray:!0,ignoreSymbols:!0}),e&&this.trigger(),this.store}trigger(){f.dispatchEvent(this.event)}watch(t){return f.addEventListener(this.eventType,t),()=>f.removeEventListener(this.eventType,t)}withGlobalChanges(t,e){return a(this,null,function*(){let n=(r,o,c)=>t.push([r,c]);this.onChangeListeners.push(n);try{yield e()}finally{let r=this.onChangeListeners.indexOf(n);r!==-1&&this.onChangeListeners.splice(r,1)}})}revertStoreChanges(t){S(_onchange2.default.target(this.store),t),this.trigger()}revertable(t){return w(this.store,t)}revertableGlobal(t){return a(this,null,function*(){let e=[];yield this.withGlobalChanges(e,()=>t(()=>this.revertStoreChanges(e)))})}transaction(t){return a(this,null,function*(){let e=_onchange2.default.target(this.store);w(e,(n,r)=>a(this,null,function*(){try{yield t(n),this.trigger()}catch(o){throw r(),o}}))})}revertOnError(t,e){this.revertable((n,r)=>a(this,null,function*(){try{yield t(n)}catch(o){if((e?e(o):!0)===!0&&r(),!e)if(this.options.defaultOnError)this.options.defaultOnError(o);else throw o}}))}revertOnErrorGlobal(t,e){return a(this,null,function*(){yield this.revertableGlobal(n=>a(this,null,function*(){try{yield t()}catch(r){if((e?e(r):!0)===!0&&n(),!e)if(this.options.defaultOnError)this.options.defaultOnError(r);else throw r}}))})}useWatch(t,e=(n,r)=>!Object.is(n,r)){let[n,r]=_react.useState.call(void 0, t(this.store)),o=_react.useRef.call(void 0, n);return _react.useEffect.call(void 0, ()=>this.watch(()=>{let i=t(this.store);(typeof e=="boolean"?e:e(i,o.current))&&(i===o.current&&typeof i=="object"&&(Array.isArray(i)?i=i.slice(0):i=Object.assign({},i)),r(i),o.current=i)}),[]),n}useRefWatch(t){let e=_react.useRef.call(void 0, t(this.store));return _react.useEffect.call(void 0, ()=>this.watch(()=>{let r=t(this.store);Object.is(r,e.current)||(e.current=r)}),[]),e}};function b(s,t,e){let n=t.at(-1);if(n!==null){if(n===void 0){if(Array.isArray(s)&&Array.isArray(e)){s.splice(0,s.length);for(let r of e)s.push(r)}return}for(let r=0;r<t.length-1;r++)s=s[t[r]];s[n]=e}}function S(s,t){for(;t.length;){let e=t.pop();e&&b(s,e[0],e[1])}}function w(s,t){let e=[],n=_onchange2.default.call(void 0, s,(r,o,c)=>{e.push([r,c])},{pathAsArray:!0,ignoreSymbols:!0});try{t(n,()=>S(s,e))}finally{_onchange2.default.unsubscribe(n)}}exports.default = g;
