"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }var c=(s,e,t)=>new Promise((n,r)=>{var i=a=>{try{f(t.next(a))}catch(p){r(p)}},o=a=>{try{f(t.throw(a))}catch(p){r(p)}},f=a=>a.done?n(a.value):Promise.resolve(a.value).then(i,o);f((t=t.apply(s,e)).next())});var _onchange = require('on-change'); var _onchange2 = _interopRequireDefault(_onchange);var _react = require('react');var d=!0,g=new EventTarget,R=0,v= exports.default =class{constructor(e,t={}){this.onChangeListeners=[];this.options=t,this.id=R++,this.eventType=`STORE_${this.id}_WATCHI_UPDATE`,this.event=new Event(this.eventType),this.store=this.set(e),this.useWatch=this.useWatch.bind(this),this.useRefWatch=this.useRefWatch.bind(this)}set(e,t=!0){return this.store&&_onchange2.default.unsubscribe(this.store),this.store=_onchange2.default.call(void 0, e,(...n)=>{for(let r of this.onChangeListeners)r(...n);this.trigger()},{pathAsArray:!0,ignoreSymbols:!0}),t&&this.trigger(),this.store}trigger(){g.dispatchEvent(this.event)}watch(e){return g.addEventListener(this.eventType,e),()=>g.removeEventListener(this.eventType,e)}withGlobalChanges(e,t){return c(this,null,function*(){let n=(r,i,o)=>e.push([r,o]);this.onChangeListeners.push(n);try{yield t()}finally{let r=this.onChangeListeners.indexOf(n);r!==-1&&this.onChangeListeners.splice(r,1)}})}revertStoreChanges(e){b(_onchange2.default.target(this.store),e),this.trigger()}revertable(e){return w(this.store,e)}revertableGlobal(e){return c(this,null,function*(){let t=[];yield this.withGlobalChanges(t,()=>e(()=>this.revertStoreChanges(t)))})}transaction(e){return c(this,null,function*(){let t=_onchange2.default.target(this.store);w(t,(n,r)=>c(this,null,function*(){try{yield e(n),this.trigger()}catch(i){throw r(),i}}))})}revertOnError(e,t){this.revertable((n,r)=>c(this,null,function*(){try{yield e(n)}catch(i){if((t?t(i):!0)===!0&&r(),!t)if(this.options.defaultOnError)this.options.defaultOnError(i);else throw i}}))}revertOnErrorGlobal(e,t){return c(this,null,function*(){yield this.revertableGlobal(n=>c(this,null,function*(){try{yield e()}catch(r){if((t?t(r):!0)===!0&&n(),!t)if(this.options.defaultOnError)this.options.defaultOnError(r);else throw r}}))})}useWatch(e,t=(n,r)=>!Object.is(n,r)){let[n,r]=_react.useState.call(void 0, e(this.store)),i=_react.useRef.call(void 0, n),o=d?_react.useRef.call(void 0, !1):void 0,f=_react.useRef.call(void 0, e),a=_react.useRef.call(void 0, t);return f.current=e,a.current=t,_react.useEffect.call(void 0, ()=>{if(o){if(o.current)return;o.current=!0}return this.watch(()=>{let u=f.current(this.store);(typeof a.current=="boolean"?a.current:a.current(u,i.current))&&(u===i.current&&typeof u=="object"&&(Array.isArray(u)?u=u.slice(0):u=Object.assign({},u)),r(u),i.current=u)})},[]),n}useRefWatch(e){let t=_react.useRef.call(void 0, e(this.store)),n=d?_react.useRef.call(void 0, !1):void 0,r=_react.useRef.call(void 0, e);return r.current=e,_react.useEffect.call(void 0, ()=>{if(n){if(n.current)return;n.current=!0}return this.watch(()=>{let o=r.current(this.store);Object.is(o,t.current)||(t.current=o)})},[]),t}target(e){return _onchange2.default.target(e)}};function O(s,e,t){let n=e.at(-1);if(n!==null){if(n===void 0){if(Array.isArray(s)&&Array.isArray(t)){s.splice(0,s.length);for(let r of t)s.push(r)}return}for(let r=0;r<e.length-1;r++)s=s[e[r]];s[n]=t}}function b(s,e){for(;e.length;){let t=e.pop();t&&O(s,t[0],t[1])}}function w(s,e){let t=[],n=_onchange2.default.call(void 0, s,(r,i,o)=>{t.push([r,o])},{pathAsArray:!0,ignoreSymbols:!0});try{e(n,()=>b(s,t))}finally{_onchange2.default.unsubscribe(n)}}exports.default = v;
