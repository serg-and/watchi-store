var a=(s,t,e)=>new Promise((n,r)=>{var o=h=>{try{i(e.next(h))}catch(l){r(l)}},c=h=>{try{i(e.throw(h))}catch(l){r(l)}},i=h=>h.done?n(h.value):Promise.resolve(h.value).then(o,c);i((e=e.apply(s,t)).next())});import u from"on-change";import{useEffect as v,useRef as p,useState as d}from"react";var f=new EventTarget,y=0,g=class{constructor(t,e={}){this.onChangeListeners=[];this.options=e,this.id=y,y++,this.eventType=`STORE_${this.id}_WATCHI_UPDATE`,this.event=new Event(this.eventType),this.store=this.set(t),this.useWatch=this.useWatch.bind(this),this.useRefWatch=this.useRefWatch.bind(this)}set(t,e=!0){return this.store&&u.unsubscribe(this.store),this.store=u(t,(...n)=>{for(let r of this.onChangeListeners)r(...n);this.trigger()},{pathAsArray:!0,ignoreSymbols:!0}),e&&this.trigger(),this.store}trigger(){f.dispatchEvent(this.event)}watch(t){return f.addEventListener(this.eventType,t),()=>f.removeEventListener(this.eventType,t)}withGlobalChanges(t,e){return a(this,null,function*(){let n=(r,o,c)=>t.push([r,c]);this.onChangeListeners.push(n);try{yield e()}finally{let r=this.onChangeListeners.indexOf(n);r!==-1&&this.onChangeListeners.splice(r,1)}})}revertStoreChanges(t){S(u.target(this.store),t),this.trigger()}revertable(t){return w(this.store,t)}revertableGlobal(t){return a(this,null,function*(){let e=[];yield this.withGlobalChanges(e,()=>t(()=>this.revertStoreChanges(e)))})}transaction(t){return a(this,null,function*(){let e=u.target(this.store);w(e,(n,r)=>a(this,null,function*(){try{yield t(n),this.trigger()}catch(o){throw r(),o}}))})}revertOnError(t,e){this.revertable((n,r)=>a(this,null,function*(){try{yield t(n)}catch(o){if((e?e(o):!0)===!0&&r(),!e)if(this.options.defaultOnError)this.options.defaultOnError(o);else throw o}}))}revertOnErrorGlobal(t,e){return a(this,null,function*(){yield this.revertableGlobal(n=>a(this,null,function*(){try{yield t()}catch(r){if((e?e(r):!0)===!0&&n(),!e)if(this.options.defaultOnError)this.options.defaultOnError(r);else throw r}}))})}useWatch(t,e=(n,r)=>!Object.is(n,r)){let[n,r]=d(t(this.store)),o=p(n);return v(()=>this.watch(()=>{let i=t(this.store);(typeof e=="boolean"?e:e(i,o.current))&&(i===o.current&&typeof i=="object"&&(Array.isArray(i)?i=i.slice(0):i=Object.assign({},i)),r(i),o.current=i)}),[]),n}useRefWatch(t){let e=p(t(this.store));return v(()=>this.watch(()=>{let r=t(this.store);Object.is(r,e.current)||(e.current=r)}),[]),e}};function b(s,t,e){let n=t.at(-1);if(n!==null){if(n===void 0){if(Array.isArray(s)&&Array.isArray(e)){s.splice(0,s.length);for(let r of e)s.push(r)}return}for(let r=0;r<t.length-1;r++)s=s[t[r]];s[n]=e}}function S(s,t){for(;t.length;){let e=t.pop();e&&b(s,e[0],e[1])}}function w(s,t){let e=[],n=u(s,(r,o,c)=>{e.push([r,c])},{pathAsArray:!0,ignoreSymbols:!0});try{t(n,()=>S(s,e))}finally{u.unsubscribe(n)}}export{g as default};
