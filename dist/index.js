"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }var u=(o,e,t)=>new Promise((s,r)=>{var n=i=>{try{a(t.next(i))}catch(f){r(f)}},c=i=>{try{a(t.throw(i))}catch(f){r(f)}},a=i=>i.done?s(i.value):Promise.resolve(i.value).then(n,c);a((t=t.apply(o,e)).next())});var _onchange = require('on-change'); var _onchange2 = _interopRequireDefault(_onchange);var _react = require('react');var p=new EventTarget,w=0,d= exports.default =class{constructor(e,t={}){this.onChangeListeners=[];this.options=t,this.id=w++,this.eventType=`STORE_${this.id}_WATCHI_UPDATE`,this.event=new Event(this.eventType),this.store=this.set(e),this.useWatch=this.useWatch.bind(this),this.useRefWatch=this.useRefWatch.bind(this)}set(e,t=!0){return this.store&&_onchange2.default.unsubscribe(this.store),this.store=_onchange2.default.call(void 0, e,(...s)=>{for(let r of this.onChangeListeners)r(...s);this.trigger()},{pathAsArray:!0,ignoreSymbols:!0}),t&&this.trigger(),this.store}trigger(){p.dispatchEvent(this.event)}watch(e){return p.addEventListener(this.eventType,e),()=>p.removeEventListener(this.eventType,e)}withGlobalChanges(e,t){return u(this,null,function*(){let s=(n,c,a)=>e.push([n,a]);this.onChangeListeners.push(s);let r;try{r=yield t()}finally{let n=this.onChangeListeners.indexOf(s);n!==-1&&this.onChangeListeners.splice(n,1)}return r})}revertStoreChanges(e){v(_onchange2.default.target(this.store),e),this.trigger()}revertable(e){return R(this.store,e)}revertableGlobal(e){return u(this,null,function*(){let t=[];return yield this.withGlobalChanges(t,()=>e(()=>this.revertStoreChanges(t)))})}transaction(e){return u(this,null,function*(){let t=_onchange2.default.target(this.store);R(t,(s,r)=>u(this,null,function*(){try{yield e(s),this.trigger()}catch(n){throw r(),n}}))})}revertOnError(e,t){return this.revertable((s,r)=>u(this,null,function*(){try{return yield e(s)}catch(n){if((t?t(n):!0)===!0&&r(),!t)if(this.options.defaultOnError)this.options.defaultOnError(n);else throw n}}))}revertOnErrorGlobal(e,t){return u(this,null,function*(){return yield this.revertableGlobal(s=>u(this,null,function*(){try{return yield e()}catch(r){if((t?t(r):!0)===!0&&s(),!t)if(this.options.defaultOnError)this.options.defaultOnError(r);else throw r}}))})}useWatch(e,t=(s,r)=>!Object.is(s,r)){let[s,r]=_react.useState.call(void 0, e(this.store)),n=_react.useRef.call(void 0, s),c=_react.useRef.call(void 0, e),a=_react.useRef.call(void 0, t);return c.current=e,a.current=t,_react.useEffect.call(void 0, ()=>this.watch(()=>{let i=c.current(this.store);(typeof a.current=="boolean"?a.current:a.current(i,n.current))&&(i===n.current&&typeof i=="object"&&(Array.isArray(i)?i=i.slice(0):i=Object.assign({},i)),r(i),n.current=i)}),[]),s}useRefWatch(e){let t=_react.useRef.call(void 0, e(this.store)),s=_react.useRef.call(void 0, e);return s.current=e,_react.useEffect.call(void 0, ()=>this.watch(()=>{let r=s.current(this.store);Object.is(r,t.current)||(t.current=r)}),[]),t}target(e){return _onchange2.default.target(e)}};function b(o,e,t){let s=e.at(-1);if(s!==null){if(s===void 0){if(Array.isArray(o)&&Array.isArray(t)){o.splice(0,o.length);for(let r of t)o.push(r)}return}for(let r=0;r<e.length-1;r++)o=o[e[r]];o[s]=t}}function v(o,e){for(;e.length;){let t=e.pop();t&&b(o,t[0],t[1])}}function R(o,e){let t=[],s=_onchange2.default.call(void 0, o,(n,c,a)=>{t.push([n,a])},{pathAsArray:!0,ignoreSymbols:!0}),r;try{r=e(s,()=>v(o,t))}finally{_onchange2.default.unsubscribe(s)}return r}exports.default = d;
